<div class="chat-history-wrapper" #messageContainer>
  @for (msg of this.chatService.msgList; track msg; let index = $index) {
  <!--msg date seperator to-do implement logic to check if msg is sent today, or in past days-->
  @if (index === 0 || msg.date != this.chatService.msgList[index-1].date) {
  <div class="msg-date">
    <div class="seperator"></div>
    <div class="date-container">
      <span>{{ checkToday(msg.date) }}</span>
    </div>
    <div class="seperator"></div>
  </div>
  } @if (msg.messageSendBy !== this.firebaseService.currentUserId) {
  <!--user-msg-->
  <div class="user-msg" [id]="msg.messageId">
    <!--msg-menu-->
    <div class="msg-menu">
      <div class="menu-content pointer"
        (click)="this.reactionService.addSpecificReaction(msg.messageId, this.reactionService.setReactionThumbUp, 'chat'); this.reactionService.currentMessageId = msg.messageId">
        <div class="emoji-container"> üëç </div>
      </div>
      <div class="menu-content pointer"
        (click)="this.reactionService.addSpecificReaction(msg.messageId, this.reactionService.setReactionThumbDown, 'chat'); this.reactionService.currentMessageId = msg.messageId">
        <div class="emoji-container"> üëé </div>
      </div>
      <div class="pointer menu-content reaction-icon" (click)="toggleEmojiPicker(index)">
        <img src="assets/img/icons/add_reaction_black.png" alt="menu-icon" />
      </div>
      <!--show only if no msgAnsers exist,-->
      @if (msg.answerCount == 0) {
      <div class="pointer menu-content" (click)="this.threadService.handleCreateThread(msg)">
        <img src="assets/img/icons/comment_black.png" alt="menu-icon" />
      </div>
      }
    </div>
    <!--user-avatar-->
    <div class="user-avatar">
      <img [src]="this.firebaseService.getUserAvatar(msg.messageSendBy)" alt="user-avatar" />
    </div>
    <!--msg-content-->
    <div class="msg-content">
      <div class="msg-top">
        <span class="pointer" (click)="
						this.communicationService.handleClickOnUser(
							msg.messageSendBy
						)
					">{{ this.firebaseService.getUserDisplayName( msg.messageSendBy )
          }}</span>
        <p>{{ this.chatService.formatTimeString(msg.time) }}</p>
      </div>

      <div class="msg">
        <!--tagged user-->
        @if (msg.taggedUser) {
          <div class="tagged-user-container">
            @for (taggedUser of msg.taggedUser; track taggedUser; let index = $index) {
              <span (click)="this.chatService.handleClickOnUser(taggedUser)" class="tagged-user pointer">{{ '@' + this.firebaseService.getUserDisplayName( taggedUser ) }}</span>
            }
          </div>
        }
        <span>{{ msg.text }}</span>
        <!--storage pic-->
        @if (msg.storageData) {
          <div class="storage-pic-container">
            <a href="{{msg.storageData}}"><img class="download-file ponter"></a>
            <img [src]="msg.storageData" alt="storage-pic" />
          </div>
        } 
        @if (msg.editCount > 0) {
        <div class="edited-msg-info">
          <p>
            Bearbeitet: {{ this.chatService.formatTimeString(msg.lastEdit) }}
          </p>
        </div>
        }
      </div>
      <!--only display if messageAnsers are present-->
      @if (msg.answerCount > 0) {
      <div class="msg-bottom" (click)="handleClickOnOpenThread(msg.messageId)">
        @if (msg.answerCount > 2 || msg.answerCount == 1) {
        <span class="pointer"> {{ msg.answerCount - 1 }} Antworten</span>
        } @else {
        <span class="pointer"> {{ msg.answerCount - 1 }} Antwort</span>
        } @if (msg.answerCount == 1) {
        <p>
          Thread erstellt {{ this.chatService.formatTimeString(msg.lastAnswer)
          }}
        </p>
        } @else {
        <p>
          Letzte Antwort {{ this.chatService.formatTimeString(msg.lastAnswer) }}
        </p>
        }
      </div>
      }
      <!--reactions container-->
      <div class="reactions-container">
        <div class="pointer add-reaction reaction-icon" (click)="toggleEmojiPicker(index)">
          <img src="assets/img/icons/add_reaction_black.png" alt="menu-icon" />
        </div>
        @for (reaction of msg.reactions; track reaction; let index = $index) {
        <div class="pointer last-reaction"
          (click)="this.reactionService.deleteReaction(reaction.reactionId, msg.messageId, 'chat')">
          <div class="emoji-container">
            {{reaction.nativeEmoji}}
          </div>
          <span class="emoji-counter">{{reaction.amount}}</span>
        </div>
        }

      </div>
      <!-- emoji Picker-->
      @if (index === this.reactionService.emojiPickerIndex) { @if
      (this.reactionService.showEmojiPicker) {
      <div class="emoji-picker-container">
        <emoji-mart (emojiClick)="this.reactionService.handleReaction($event, msg.messageId, 'chat')"></emoji-mart>
      </div>
      } }
    </div>
  </div>
  }
  <!--current-user-msg-->
  @if (msg.messageSendBy == this.firebaseService.currentUserId) {
  <div class="current-user-msg" [id]="msg.messageId">
    <!--msg-menu only show for current user-->
    <div class="msg-menu">
      <div class="menu-content pointer"
        (click)="this.reactionService.addSpecificReaction(msg.messageId, this.reactionService.setReactionThumbUp, 'chat'); this.reactionService.currentMessageId = msg.messageId">
        <div class="emoji-container"> üëç </div>
      </div>
      <div class="menu-content pointer"
        (click)="this.reactionService.addSpecificReaction(msg.messageId, this.reactionService.setReactionThumbDown, 'chat'); this.reactionService.currentMessageId = msg.messageId">
        <div class="emoji-container"> üëé </div>
      </div>
      <div class="pointer menu-content" (click)="toggleEmojiPicker(index)">
        <img src="assets/img/icons/add_reaction_black.png" alt="menu-icon" />
      </div>
      <!--show only if no msgAnsers exist,-->
      @if (msg.answerCount == 0) {
      <div class="pointer menu-content" (click)="this.threadService.handleCreateThread(msg)">
        <img src="assets/img/icons/comment_black.png" alt="menu-icon" />
      </div>
      }
      <div class="pointer menu-content" (click)="toggleMsgMenu()">
        <img src="assets/img/icons/more_vert_black.png" alt="menu-icon" />
      </div>
      <!--sub menu "edit-msg"-->
      @if (this.communicationService.isMsgMenuVisible) {
      <div class="edit-msg-menu">
        <!--add logic to edit msg-->
        <div class="edit-msg pointer" (click)="handleClickOnEditMsg(msg.messageId, msg.threadId)">
          <span>Nachricht bearbeiten</span>
        </div>
        <!--add logic to delete msg-->
        <div class="edit-msg pointer" (click)="handleClickOnDeleteMsg(msg.messageId)">
          <span>Nachricht l√∂schen</span>
        </div>
      </div>
      }
    </div>
    <!--msg-content-->
    <div class="current-user-msg-content">
      <div class="current-user-msg-top">
        <p>{{ this.chatService.formatTimeString(msg.time) }}</p>
        <span class="pointer" (click)="this.communicationService.handleClickCurrentUser(true)">{{ this.firebaseService.getUserDisplayName(this.firebaseService.currentUserId ) }}</span>
      </div>

      <div class="current-user-msg">
        <!--tagged user-->
        @if (msg.taggedUser) {
          <div class="tagged-user-container">
            @for (taggedUser of msg.taggedUser; track taggedUser; let index = $index) {
              <span (click)="this.chatService.handleClickOnUser(taggedUser)" class="tagged-user pointer">{{ '@' + this.firebaseService.getUserDisplayName( taggedUser ) }}</span>
            }
          </div>
        }
        <span>{{ msg.text }}</span>
        <!--storage pic-->
        @if (msg.storageData) {
          <div class="storage-pic-container">
            <span class="download pointer">
				<img class="download-icon" src="assets/img/icons/download_white.png" alt="">
			</span>
			<a href="{{msg.storageData}}" target="_blank">
				<img src="{{msg.storageData}}">
			</a>
          </div>
          } 
        @if (msg.editCount > 0) {
        <div class="edited-msg-info">
          <p>
            Bearbeitet: {{ this.chatService.formatTimeString(msg.lastEdit) }}
          </p>
        </div>
        }
      </div>
      <!--only display if messageAnsers are present-->
      @if (msg.answerCount > 0) {
      <div class="current-user-msg-bottom" (click)="handleClickOnOpenThread(msg.messageId)">
        @if (msg.answerCount > 2 || msg.answerCount == 1) {
        <span class="pointer"> {{ msg.answerCount - 1 }} Antworten</span>
        } @else {
        <span class="pointer"> {{ msg.answerCount - 1 }} Antwort</span>
        } @if (msg.answerCount == 1) {
        <p>
          Thread erstellt {{ this.chatService.formatTimeString(msg.lastAnswer)
          }}
        </p>
        } @else {
        <p>
          Letzte Antwort {{ this.chatService.formatTimeString(msg.lastAnswer) }}
        </p>
        }
      </div>
      }
      <!--reactions container-->
      <div class="reactions-container">
        @for (reaction of msg.reactions; track reaction; let index = $index) {
        <div class="pointer last-reaction"
          (click)="this.reactionService.deleteReaction(reaction.reactionId, msg.messageId, 'chat')">
          <div class="emoji-container">
            {{reaction.nativeEmoji}}
          </div>
          <span class="emoji-counter">{{reaction.amount}}</span>
        </div>
        }
        <div class="pointer add-reaction reaction-icon" (click)="toggleEmojiPicker(index)">
          <img src="assets/img/icons/add_reaction_black.png" alt="menu-icon" />
        </div>
      </div>
    </div>
    <div class="current-user-avatar">
      <img [src]="
					this.firebaseService.getUserAvatar(
						this.firebaseService.currentUserId
					)
				" alt="user-avatar" />
    </div>
    <!--popUp overlay for editing specific current user msg-->
    @if (showEditMsgOverlay && msg.messageId === this.chatService.editMessageId) {
    <div class="edit-msg-overlay">
      <div class="left-section">
        <form class="edit-msg-form" [formGroup]="newMsgData" (submit)="onSubmitEditMsg()">
          <div class="top-section">
            <textarea placeholder="Nachricht bearbeiten" formControlName="text"></textarea>
          </div>
          <div class="bottom-section">
            <div class="bottom-left pointer">
              <img src="assets/img/icons/add_reaction_black.png" alt="add-reaction-icon" />
            </div>
            <div class="bottom-right">
              <button type="button" class="cancel-btn pointer" (click)="handleClickOnCancel()">
                <span>Abbrechen</span>
              </button>
              <button type="submit" class="save-btn pointer">
                <span>Speichern</span>
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="right-section">
        <div class="current-user-avatar">
          <img [src]="this.firebaseService.getUserAvatar(this.firebaseService.currentUserId)" alt="user-avatar" />
        </div>
      </div>
    </div>
    }
    <!--popUp overlay for deleting specific current user msg-->
    @if ( this.communicationService.isDeleteMsgDialogVisible && msg.messageId === this.chatService.editMessageId) {
    <div class="delete-msg-dialog">
      <span>M√∂chtest du diese Nachricht wirklich l√∂schen?</span>
      <div class="dialog-btns">
        <button class="cancel-btn pointer" (click)="handleClickOnCancelDeleteMsg()">
          <span>Abbrechen</span>
        </button>
        <button class="delete-btn pointer" (click)="handleClickOnConfirmDeleteMsg()">
          <span>L√∂schen</span>
        </button>
      </div>
    </div>
    }
  </div>
  <!-- emoji Picker-->
  @if (index === this.reactionService.emojiPickerIndex && this.reactionService.showEmojiPicker) { 
  <div class="emoji-picker-container">
    <emoji-mart (emojiClick)="this.reactionService.handleReaction($event, msg.messageId, 'chat')"></emoji-mart>
  </div>
 }
 } }

</div>